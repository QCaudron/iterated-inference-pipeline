<!DOCTYPE html>  <html> <head>   <title>kalman.c</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               kalman.c             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>Extended Kalman Filter</h1>

<p>In C with adaptive-step integration.</p>

<h3>Compilation</h3>

<p>We use libplom and libplomtpl (the templates of your specific model)
<code>gcc -fopenmp -std=gnu99 -Wall -O3 -I C/core/ -L C/lib kalman.c -o smc -lplom -lplomtpl -lm -lgsl -lgslcblas -ljansson -lzmq</code></p>

<h3>Usage</h3>

<p><code>./kalman &lt; theta.json</code>
Parameters are read from <em>stdin</em>, the log likelihood is returned</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="cp">#include &quot;plom.h&quot;</span>


<span class="kt">double</span> <span class="nf">run_kalman</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_X</span> <span class="o">*</span><span class="n">p_X</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_best</span> <span class="o">*</span><span class="n">p_best</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_par</span> <span class="o">*</span><span class="n">p_par</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_kal</span> <span class="o">*</span><span class="n">p_kal</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_common</span> <span class="o">*</span><span class="n">p_common</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_data</span> <span class="o">*</span><span class="n">p_data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_calc</span> <span class="o">**</span><span class="n">calc</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">p_file_X</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">)</span>
<span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Global Variables</h2>

<p>All global variables are defined in plom.h
Typically these values will be prompted from <em>stdin</em> but here we assign them</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">J</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="c1">//Number of particles</span>
    <span class="n">GENERAL_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//unique ID to generate a seed and sign the output files</span>
    <span class="n">LIKE_MIN</span> <span class="o">=</span> <span class="mf">1e-17</span><span class="p">;</span> <span class="n">LOG_LIKE_MIN</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">LIKE_MIN</span><span class="p">);</span> <span class="c1">//minimum value of the likelihood</span>

    
    </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Inputs (JSON)</h2>

<p>All PLoM inputs are in <a href="http://www.json.org/">JSON</a>. JSON is handled on the C side with the lib <a href="http://www.digip.org/jansson/">Jansson</a></p>

<h3>settings</h3>

<p>settings comes from a JSON <strong>file</strong> (settings.json) containing:</p>

<ul>
<li>the data</li>
<li>all the constant representing the various dimension of your model. Most of this constant are global variables (for instance <em>N_PAR_SV</em> is the number of state variables...).</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">json_t</span> <span class="o">*</span><span class="n">settings</span> <span class="o">=</span> <span class="n">load_settings</span><span class="p">(</span><span class="n">PATH_SETTINGS</span><span class="p">);</span> <span class="c1">//PATH_SETTINGS is defined in plom.h (defaults to settings/settings.json)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h3>theta</h3>

<p>theta comes from a JSON document (theta.json) <strong>read from stdin</strong> containing the parameter values and some information on their <strong>transformation</strong> and <strong>grouping</strong>.
<em>load_json</em>  will block waiting from input from <em>stdin</em>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">json_t</span> <span class="o">*</span><span class="n">theta</span> <span class="o">=</span> <span class="n">load_json</span><span class="p">();</span>
    
    </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h2>Memory allocation</h2>

<p>We create the main data structure used by the various inference methods</p>

<ul>
<li><em>p_data</em>: the <strong>immutable</strong> data. The data itself and all the navigation data required to iterate through the parameters.</li>
<li><em>p_X</em>: an object representing the state variables, the observed variable and the drifted variables.</li>
<li><em>p_best</em>: The parameters (in the <strong>transformed</strong> scale) and everything needed to mutate the parameters. <em>p_best</em> is typically used for inference methods (MIF, pMCMC, simplex...)</li>
<li><em>p_par</em>: The parameters in the <strong>natural</strong> scale</li>
<li><em>p_kal</em>: a structure containing the objects needed for the EKF: the Covariance matrix Ct, the Process Jacobian Ft, the gain kt, the prediction error, and other temporary variables that are needed in the update process</li>
<li><em>p_common</em>: a structure containing the diffusion matrix Q and the jacobian of the observation process, ht.</li>
<li><em>calc</em>: an array containing one <em>p_calc</em> object per thread. <em>p_calc</em> objects are to support the calculations in multi-threaded environments. <em>p_calc</em> objects store everything related to random number generators, numerical integration methods and <strong>mutable</strong> states that need to be computed <strong>in parallel</strong>.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>    
    
    <span class="k">struct</span> <span class="n">s_data</span> <span class="o">*</span><span class="n">p_data</span> <span class="o">=</span> <span class="n">build_data</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">s_X</span> <span class="o">*</span><span class="n">p_X</span> <span class="o">=</span> <span class="n">build_X</span><span class="p">(</span><span class="n">p_data</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">s_best</span> <span class="o">*</span><span class="n">p_best</span> <span class="o">=</span> <span class="n">build_best</span><span class="p">(</span><span class="n">p_data</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">s_par</span> <span class="o">*</span><span class="n">p_par</span> <span class="o">=</span> <span class="n">build_par</span><span class="p">(</span><span class="n">p_data</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">s_kal</span> <span class="o">*</span><span class="n">p_kal</span> <span class="o">=</span> <span class="n">build_kal</span><span class="p">();</span>
    <span class="k">struct</span> <span class="n">s_common</span> <span class="o">*</span><span class="n">p_common</span> <span class="o">=</span> <span class="n">build_common</span><span class="p">();</span>
    <span class="k">struct</span> <span class="n">s_calc</span> <span class="o">**</span><span class="n">calc</span> <span class="o">=</span> <span class="n">build_calc</span><span class="p">(</span><span class="n">GENERAL_ID</span><span class="p">,</span> <span class="n">N_PAR_SV</span><span class="o">*</span><span class="n">N_CAC</span> <span class="o">+</span><span class="n">N_TS_INC_UNIQUE</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">p_data</span><span class="p">);</span>
    </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>We are done with the json objects, we free them.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">json_decref</span><span class="p">(</span><span class="n">settings</span><span class="p">);</span>
    <span class="n">json_decref</span><span class="p">(</span><span class="n">theta</span><span class="p">);</span>
    
    
    </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h1>The Extended Kalman Filter</h1>             </td>             <td class="code">               <div class="highlight"><pre>    </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>loops indices</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">nn</span><span class="p">;</span>    <span class="c1">// data and nonan data indices</span>
    <span class="kt">double</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">;</span>  <span class="c1">// first and last times</span>
    <span class="kt">int</span> <span class="n">ts</span><span class="p">,</span> <span class="n">ts_nonan</span><span class="p">;</span> <span class="c1">// time series indices</span>
    </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>likelihoods</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kt">double</span> <span class="n">like</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">log_lik</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">log_lik_temp</span><span class="p">;</span>
    
    <span class="k">struct</span> <span class="n">s_data_ind</span> <span class="o">**</span><span class="n">data_ind</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">-&gt;</span><span class="n">data_ind</span><span class="p">;</span>
    
    <span class="n">t0</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">log_lik</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>For every time step when the data are not all NaN (which is how missing values are represented)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">n</span><span class="o">&lt;</span><span class="n">N_DATA_NONAN</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h2>Projection</h2>

<p>We project \p_X to the next data point</p>             </td>             <td class="code">               <div class="highlight"><pre>        </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>The time of the next data point</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">t1</span><span class="o">=</span><span class="n">p_data</span><span class="o">-&gt;</span><span class="n">times</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
        
        </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Data points might not be equally spaced... We use this sub loop (on <em>nn</em>) to simulate equally spaced time step and ensure that incidences are regularly reset to 0.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">for</span><span class="p">(</span><span class="n">nn</span><span class="o">=</span><span class="n">t0</span><span class="p">;</span> <span class="n">nn</span><span class="o">&lt;</span><span class="n">t1</span><span class="p">;</span> <span class="n">nn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">store_state_current_n_nn</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">nn</span><span class="p">);</span>
            </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>At the end of each observation period, the incidence is brought back to 0 as well as the corresponding uncertainty reflected in the covariance matrix Ct</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="n">reset_inc</span><span class="p">(</span><span class="n">p_X</span><span class="p">);</span> 
            <span class="n">reset_inc_Cov</span><span class="p">(</span><span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">Ct</span><span class="p">);</span> 
            </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>The mean state and covariance are concatenated in a list to be handed to the integrating tool of the gsl library. </p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="kt">double</span> <span class="n">xc</span><span class="p">[</span><span class="n">N_PAR_SV</span><span class="o">*</span><span class="n">N_CAC</span><span class="o">+</span><span class="n">N_TS_INC_UNIQUE</span> <span class="o">+</span> <span class="n">N_KAL</span><span class="o">*</span><span class="p">(</span><span class="n">N_KAL</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">];</span>
            <span class="n">X2xc</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">p_X</span><span class="p">,</span> <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">Ct</span><span class="p">);</span>
            </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Integration of the process model from nn to nnp1 with the following formulae:</p>

<p>dp<em>X += f(p</em>X)dt</p>

<p>dCt  += [Ft(p<em>X)*Ct + Ct*t(Ft(p</em>X)) + Q]dt</p>

<p>with f being the deterministic skeleton of the model, Ft its Jacobian, and Q the dispersion matrix</p>             </td>             <td class="code">               <div class="highlight"><pre>        
            <span class="n">f_prediction_ode_rk</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">nn</span><span class="p">,</span> <span class="n">nn</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">p_par</span><span class="p">,</span> <span class="n">calc</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            
            </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Recovery of the mean state and covariance from the concatenated list xc</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N_PAR_SV</span><span class="o">*</span><span class="n">N_CAC</span><span class="o">+</span><span class="n">N_TS_INC_UNIQUE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">p_X</span><span class="o">-&gt;</span><span class="n">proj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">xc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="n">list2sym_matrix</span><span class="p">(</span><span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">Ct</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
            
        <span class="p">}</span> 
        </pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>We transform p<em>X, which was a compact representation of the state, into x</em>k that accounts for all the observed quantities</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">X2xk</span><span class="p">(</span><span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">xk</span><span class="p">,</span> <span class="n">p_X</span><span class="p">,</span> <span class="n">p_data</span><span class="p">);</span>
 
        </pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h2>Update</h2>             </td>             <td class="code">               <div class="highlight"><pre>        
        <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">sc_rt</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
        <span class="n">log_lik_temp</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Observations are assimilated one by one, which does not change the outcome but makes the code more robust to varying numbers of observations.</p>             </td>             <td class="code">               <div class="highlight"><pre>        
        <span class="k">for</span><span class="p">(</span><span class="n">ts</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ts</span><span class="o">&lt;</span> <span class="n">data_ind</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">n_nonan</span><span class="p">;</span> <span class="n">ts</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <h3>Computation of rt</h3>

<p>variance of the observation process:</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">sc_rt</span> <span class="o">=</span> <span class="n">obs_var</span><span class="p">(</span><span class="n">gsl_vector_get</span><span class="p">(</span><span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">xk</span><span class="p">,</span> <span class="n">N_PAR_SV</span><span class="o">*</span><span class="n">N_CAC</span> <span class="o">+</span> <span class="n">ts_nonan</span><span class="p">),</span> <span class="n">p_par</span><span class="p">,</span> <span class="n">p_data</span><span class="p">,</span> <span class="n">calc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ts_nonan</span><span class="p">);</span>
            </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h3>Evaluation of ht</h3>

<p>gradient of sthe observation process:</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="n">eval_ht</span><span class="p">(</span><span class="n">p_common</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">,</span> <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">xk</span><span class="p">,</span> <span class="n">p_par</span><span class="p">,</span> <span class="n">p_data</span><span class="p">,</span> <span class="n">calc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ts_nonan</span><span class="p">);</span>
            </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <h3>Gain Computation</h3>

<p>st = ht<em>Ct</em>ht + rt</p>

<p>kt = Ct*ht/st</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="n">ekf_gain_computation</span><span class="p">(</span><span class="n">obs_mean</span><span class="p">(</span><span class="n">gsl_vector_get</span><span class="p">(</span><span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">xk</span><span class="p">,</span> <span class="n">N_PAR_SV</span><span class="o">*</span><span class="n">N_CAC</span> <span class="o">+</span><span class="n">ts_nonan</span><span class="p">),</span> <span class="n">p_par</span><span class="p">,</span> <span class="n">p_data</span><span class="p">,</span> <span class="n">calc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ts_nonan</span><span class="p">),</span>
                                 <span class="n">p_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">calc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">current_nn</span><span class="p">][</span><span class="n">ts_nonan</span><span class="p">],</span>
                                 <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">Ct</span><span class="p">,</span> <span class="n">p_common</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">,</span> <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">kt</span><span class="p">,</span> <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">sc_rt</span><span class="p">,</span>
                                 <span class="o">&amp;</span><span class="p">(</span><span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">sc_st</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">sc_pred_error</span><span class="p">));</span>
            </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h3>Update of xk, Ct, and the likelihood</h3>

<p>xk = xk + kt*(pred_error)</p>

<p>Ct = (Id - kt<em>ht)</em>Ct</p>

<p>lik *= N(pred_error,st)</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="n">like</span> <span class="o">=</span> <span class="n">ekf_update</span><span class="p">(</span><span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">xk</span><span class="p">,</span> <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">Ct</span><span class="p">,</span> <span class="n">p_common</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">,</span> <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">kt</span><span class="p">,</span> <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">sc_st</span><span class="p">,</span> <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">sc_pred_error</span><span class="p">);</span>
            <span class="n">log_lik_temp</span> <span class="o">+=</span> <span class="n">log</span><span class="p">(</span><span class="n">like</span><span class="p">);</span>
        <span class="p">}</span>
        </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Echo back the change on xk to p<em>X->proj and p</em>X->drift</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">xk2X</span><span class="p">(</span><span class="n">p_X</span><span class="p">,</span> <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">xk</span><span class="p">,</span> <span class="n">p_data</span><span class="p">);</span>
        
        <span class="n">log_lik</span> <span class="o">+=</span> <span class="n">log_lik_temp</span><span class="p">;</span>
        <span class="n">t0</span><span class="o">=</span><span class="n">t1</span><span class="p">;</span>
        
    <span class="p">}</span> <span class="c1">// end of for loop on n</span>
    
    </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h2>Result (output)</h2>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="n">log_lik</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 