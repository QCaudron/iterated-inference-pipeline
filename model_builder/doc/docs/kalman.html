<!DOCTYPE html>  <html> <head>   <title>kalman.c</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               kalman.c             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>Extended Kalman Filter</h1>

<p>In C with adaptive-step integration.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">struct</span> <span class="n">s_kal</span>
<span class="p">{</span>
    <span class="n">gsl_vector</span> <span class="o">*</span><span class="n">xk</span><span class="p">;</span>  <span class="c1">// concatenation of non-overlapping components of X-&gt;proj, X-&gt;obs and X-&gt;drift</span>
    <span class="n">gsl_vector</span> <span class="o">*</span><span class="n">kt</span><span class="p">;</span>  <span class="c1">// Kalman Gain vector</span>
    <span class="n">gsl_vector</span> <span class="o">*</span><span class="n">ht</span><span class="p">;</span>  <span class="c1">// Gradient of the observation function</span>

    <span class="kt">double</span> <span class="n">sc_st</span><span class="p">;</span>         <span class="c1">// Innovation or residual covariance</span>
    <span class="kt">double</span> <span class="n">sc_pred_error</span><span class="p">;</span> <span class="c1">// Innovation or measurement residual</span>
    <span class="kt">double</span> <span class="n">sc_rt</span><span class="p">,</span>         <span class="c1">//observation process variance</span>
<span class="p">};</span>



<span class="kt">double</span> <span class="nf">run_kalman</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_X</span> <span class="o">*</span><span class="n">p_X</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_best</span> <span class="o">*</span><span class="n">p_best</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_par</span> <span class="o">*</span><span class="n">p_par</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_kal</span> <span class="o">*</span><span class="n">p_kal</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_data</span> <span class="o">*</span><span class="n">p_data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_calc</span> <span class="o">**</span><span class="n">calc</span><span class="p">)</span>
<span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>loops indices</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">nn</span><span class="p">;</span>    <span class="c1">// data and nonan data indices</span>
    <span class="kt">double</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">;</span>  <span class="c1">// first and last times</span>
    <span class="kt">int</span> <span class="n">ts</span><span class="p">,</span> <span class="n">ts_nonan</span><span class="p">;</span> <span class="c1">// time series indices</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>likelihoods</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kt">double</span> <span class="n">like</span><span class="p">,</span> <span class="n">log_lik</span><span class="p">,</span> <span class="n">log_lik_temp</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>(re)set to 0</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">t0</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">log_lik</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">sc_st</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">sc_pred_error</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>the Covariance matrix Ct</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">gsl_matrix_view</span> <span class="n">Ct</span> <span class="o">=</span> <span class="n">gsl_matrix_view_array</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">p_X</span><span class="o">-&gt;</span><span class="n">proj</span><span class="p">[</span><span class="n">PLOM_SIZE_PROJ</span><span class="p">]),</span> <span class="n">N_KAL</span><span class="p">,</span> <span class="n">N_KAL</span><span class="p">);</span>
    <span class="n">gsl_matrix_set_zero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Ct</span><span class="p">.</span><span class="n">matrix</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>For every time step when the data are not all NaN (which is how missing values are represented)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">n</span><span class="o">&lt;</span><span class="n">N_DATA_NONAN</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>Projection</h2>

<p>We project p_X to the next data point</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>The time of the next data point</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">t1</span><span class="o">=</span><span class="n">p_data</span><span class="o">-&gt;</span><span class="n">times</span><span class="p">[</span><span class="n">n</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>To be hidden... drifted parameters are stored in p_calc->natural_drifted_safe. We initialize the values from p_X->drift[i][k]</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">drift_par</span><span class="p">(</span><span class="n">calc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p_data</span><span class="p">,</span> <span class="n">p_X</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p_data</span><span class="o">-&gt;</span><span class="n">p_it_only_drift</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Data points might not be equally spaced... We use this sub loop (on <em>nn</em>) to simulate equally spaced time step and ensure that incidences are regularly reset to 0.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">for</span><span class="p">(</span><span class="n">nn</span><span class="o">=</span><span class="n">t0</span><span class="p">;</span> <span class="n">nn</span><span class="o">&lt;</span><span class="n">t1</span><span class="p">;</span> <span class="n">nn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">store_state_current_n_nn</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">nn</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>At the end of each observation period, the incidence is brought back to 0 as well as the corresponding uncertainty reflected in the covariance matrix Ct</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="n">reset_inc</span><span class="p">(</span><span class="n">p_X</span><span class="p">);</span>
            <span class="n">reset_inc_cov</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Ct</span><span class="p">.</span><span class="n">matrix</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Integration of the process model from nn to nn+1 with the following formulae:</p>

<p>dp_X += f(p_X)dt</p>

<p>dCt  += [Ft(p_X)<em>Ct + Ct</em>t(Ft(p_X)) + Q]dt</p>

<p>with <em>f</em> being the deterministic skeleton of the model, <em>Ft</em> its Jacobian, and <em>Q</em> the dispersion matrix</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="n">f_prediction_ode_rk</span><span class="p">(</span><span class="n">p_X</span><span class="o">-&gt;</span><span class="n">proj</span><span class="p">,</span> <span class="n">nn</span><span class="p">,</span> <span class="n">nn</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">p_par</span><span class="p">,</span> <span class="n">calc</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            <span class="n">proj2obs</span><span class="p">(</span><span class="n">p_X</span><span class="p">,</span> <span class="n">p_data</span><span class="p">);</span>

        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>We transform <em>p_X</em>, which was a compact representation of the state, into <em>x_k</em> that accounts for all the observed quantities</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">X2xk</span><span class="p">(</span><span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">xk</span><span class="p">,</span> <span class="n">p_X</span><span class="p">,</span> <span class="n">p_data</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h2>Update</h2>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">log_lik_temp</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Observations are assimilated one by one, which does not change the outcome but makes the code more robust to varying numbers of observations.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">for</span><span class="p">(</span><span class="n">ts</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ts</span><span class="o">&lt;</span> <span class="n">p_data</span><span class="o">-&gt;</span><span class="n">data_ind</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">n_nonan</span><span class="p">;</span> <span class="n">ts</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

            <span class="n">ts_nonan</span> <span class="o">=</span> <span class="n">p_data</span><span class="o">-&gt;</span><span class="n">data_ind</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ind_nonan</span><span class="p">[</span><span class="n">ts</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h3>Computation of <em>sc_rt</em></h3>

<p>variance of the observation process:</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">sc_rt</span> <span class="o">=</span> <span class="n">obs_var</span><span class="p">(</span><span class="n">gsl_vector_get</span><span class="p">(</span><span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">xk</span><span class="p">,</span> <span class="n">N_PAR_SV</span><span class="o">*</span><span class="n">N_CAC</span> <span class="o">+</span> <span class="n">ts_nonan</span><span class="p">),</span> <span class="n">p_par</span><span class="p">,</span> <span class="n">p_data</span><span class="p">,</span> <span class="n">calc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ts_nonan</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h3>Evaluation of ht</h3>

<p>gradient of the observation process:</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="n">eval_ht</span><span class="p">(</span><span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">,</span> <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">xk</span><span class="p">,</span> <span class="n">p_par</span><span class="p">,</span> <span class="n">p_data</span><span class="p">,</span> <span class="n">calc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ts_nonan</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h3>Gain Computation</h3>

<p>sc_pred_error = data_t_ts - xk_t_ts (estimate at time <em>t</em> of the observed quantity)</p>

<p>sc_st = ht' * Ct * ht + sc_rt</p>

<p>kt = Ct * ht' * sc_st^-1</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="n">ekf_gain_computation</span><span class="p">(</span><span class="n">obs_mean</span><span class="p">(</span><span class="n">gsl_vector_get</span><span class="p">(</span><span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">xk</span><span class="p">,</span> <span class="n">N_PAR_SV</span><span class="o">*</span><span class="n">N_CAC</span> <span class="o">+</span><span class="n">ts_nonan</span><span class="p">),</span> <span class="n">p_par</span><span class="p">,</span> <span class="n">p_data</span><span class="p">,</span> <span class="n">calc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ts_nonan</span><span class="p">),</span> <span class="c1">//xk_t_ts</span>
                                 <span class="n">p_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">calc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">current_nn</span><span class="p">][</span><span class="n">ts_nonan</span><span class="p">],</span> <span class="c1">// data_t_ts</span>
                                 <span class="o">&amp;</span><span class="n">Ct</span><span class="p">.</span><span class="n">matrix</span><span class="p">,</span> <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">,</span> <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">kt</span><span class="p">,</span> <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">sc_rt</span><span class="p">,</span>
                                 <span class="o">&amp;</span><span class="p">(</span><span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">sc_st</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">sc_pred_error</span><span class="p">));</span> <span class="c1">// scalar sc_st and sc_pred_error will be modified so we pass their address</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h3>Update of xk, Ct, and the likelihood</h3>

<p>xk = xk + kt*(pred_error)</p>

<p>Ct = (Id - kt<em>ht)</em>Ct</p>

<p>lik *= N(sc_pred_error, sqrt(sc_st))</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="n">like</span> <span class="o">=</span> <span class="n">ekf_update</span><span class="p">(</span><span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">xk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Ct</span><span class="p">.</span><span class="n">matrix</span><span class="p">,</span> <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">,</span> <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">kt</span><span class="p">,</span> <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">sc_st</span><span class="p">,</span> <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">sc_pred_error</span><span class="p">);</span>
            <span class="n">log_lik_temp</span> <span class="o">+=</span> <span class="n">log</span><span class="p">(</span><span class="n">like</span><span class="p">);</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Echo back the change on <em>xk</em> to <em>p_X->proj</em> and <em>p_X->drift</em></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">xk2X</span><span class="p">(</span><span class="n">p_X</span><span class="p">,</span> <span class="n">p_kal</span><span class="o">-&gt;</span><span class="n">xk</span><span class="p">,</span> <span class="n">p_data</span><span class="p">);</span>

        <span class="n">log_lik</span> <span class="o">+=</span> <span class="n">log_lik_temp</span><span class="p">;</span>
        <span class="n">t0</span><span class="o">=</span><span class="n">t1</span><span class="p">;</span>

    <span class="p">}</span> <span class="c1">// end of for loop on n</span>

    <span class="k">return</span> <span class="n">log_lik</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 